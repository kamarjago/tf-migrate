#!/usr/bin/env bash

# run-e2e-tests
# End-to-end test script that validates v4 to v5 migration
# 1. Applies v4 configs
# 2. Migrates to v5
# 3. Applies v5 configs
# 4. Compares outputs to ensure no drift

set -euo pipefail

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# Configuration
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
TF_MIGRATE_ROOT="$(dirname "$SCRIPT_DIR")"
E2E_ROOT="${TF_MIGRATE_ROOT}/e2e"
V4_DIR="${E2E_ROOT}/tf/v4"
V5_DIR="${E2E_ROOT}/migrated-v4_to_v5"
TMP_DIR="${E2E_ROOT}/tmp"
BINARY="${TF_MIGRATE_ROOT}/tf-migrate"
SKIP_V4_TEST=false
RESOURCES=""
TARGET_ARGS=""

# Parse arguments
while [[ $# -gt 0 ]]; do
  case $1 in
    --skip-v4-test)
      SKIP_V4_TEST=true
      shift
      ;;
    --resources)
      RESOURCES="$2"
      shift 2
      ;;
    -h|--help)
      echo "Usage: $0 [OPTIONS]"
      echo ""
      echo "Options:"
      echo "  --skip-v4-test                     Skip v4 testing phase and go straight to migration"
      echo "  --resources <resource1,resource2>  Target specific resources (comma-separated module names)"
      echo "  -h, --help                         Show this help message"
      echo ""
      echo "Examples:"
      echo "  $0                                           # Run full e2e test for all resources"
      echo "  $0 --skip-v4-test                           # Skip v4 phase, migrate and test v5"
      echo "  $0 --resources dns_record                   # Test only dns_record module"
      echo "  $0 --resources dns_record,zone_dnssec       # Test multiple modules"
      echo "  $0 --skip-v4-test --resources dns_record    # Combined: skip v4, test only dns_record"
      echo ""
      exit 0
      ;;
    *)
      echo "Unknown option: $1"
      echo "Usage: $0 [--skip-v4-test] [--resources resource1,resource2,...] [-h|--help]"
      exit 1
      ;;
  esac
done

# Build target arguments if resources are specified
if [[ -n "$RESOURCES" ]]; then
  echo -e "${CYAN}Targeting specific resources: ${RESOURCES}${NC}"
  IFS=',' read -ra RESOURCE_ARRAY <<< "$RESOURCES"
  for resource in "${RESOURCE_ARRAY[@]}"; do
    # Prepend module. to each resource name
    TARGET_ARGS="${TARGET_ARGS} -target=module.${resource}"
  done
  echo -e "${CYAN}Target arguments: ${TARGET_ARGS}${NC}"
  echo ""
fi

# Create tmp directory
mkdir -p "${TMP_DIR}"

echo -e "${CYAN}========================================${NC}"
echo -e "${CYAN}E2E Migration Test${NC}"
echo -e "${CYAN}========================================${NC}"
echo ""

# Show tips based on current configuration
if [[ "$SKIP_V4_TEST" == "false" ]] && [[ -z "$RESOURCES" ]]; then
  echo -e "${YELLOW}Tips:${NC}"
  echo -e "${YELLOW}  • Use --skip-v4-test to skip v4 testing and go straight to migration${NC}"
  echo -e "${YELLOW}  • Use --resources <name> to test specific modules (e.g., --resources dns_record)${NC}"
  echo -e "${YELLOW}  • Run --help to see all available options${NC}"
  echo ""
elif [[ "$SKIP_V4_TEST" == "false" ]] && [[ -n "$RESOURCES" ]]; then
  echo -e "${YELLOW}Tip: Use --skip-v4-test to skip v4 testing and go straight to migration${NC}"
  echo ""
fi

# Check if e2e directory exists
if [[ ! -d "$E2E_ROOT" ]]; then
    echo -e "${RED}Error: e2e directory not found at $E2E_ROOT${NC}"
    exit 1
fi

# Step 0: Initialize test resources
echo -e "${CYAN}Step 0: Initializing test resources${NC}"

# Check for required environment variables
if [[ -z "${CLOUDFLARE_ACCOUNT_ID:-}" ]] || [[ -z "${CLOUDFLARE_ZONE_ID:-}" ]]; then
    echo -e "${RED}Error: CLOUDFLARE_ACCOUNT_ID and CLOUDFLARE_ZONE_ID environment variables are required${NC}"
    echo -e "${YELLOW}Set them before running this script or pass them when calling:${NC}"
    echo -e "${YELLOW}CLOUDFLARE_ACCOUNT_ID=<id> CLOUDFLARE_ZONE_ID=<id> ./scripts/run-e2e-tests${NC}"
    exit 1
fi

echo -e "${GREEN}Running tests with:${NC}"
echo -e "  ${CYAN}User:       ${CLOUDFLARE_EMAIL}${NC}"
echo -e "  ${CYAN}Account ID: ${CLOUDFLARE_ACCOUNT_ID}${NC}"
echo -e "  ${CYAN}Zone ID:    ${CLOUDFLARE_ZONE_ID}${NC}"
echo ""

echo -e "${YELLOW}Running init script...${NC}"
if ! "${E2E_ROOT}/scripts/init" --account "$CLOUDFLARE_ACCOUNT_ID" --zone "$CLOUDFLARE_ZONE_ID" > "${TMP_DIR}/init.log" 2>&1; then
    echo -e "${RED}✗ Init script failed${NC}"
    echo ""
    echo -e "${RED}Error output:${NC}"
    cat "${TMP_DIR}/init.log"
    exit 1
fi
echo -e "${GREEN}✓ Test resources initialized${NC}"
echo ""

# Always build the binary to ensure it's up to date with latest code
echo -e "${YELLOW}Building tf-migrate binary...${NC}"
if ! (cd "$TF_MIGRATE_ROOT" && go build -o tf-migrate ./cmd/tf-migrate); then
    echo -e "${RED}✗ Failed to build tf-migrate binary${NC}"
    exit 1
fi
echo -e "${GREEN}✓ Binary built successfully${NC}"
echo ""

# Step 1: Initialize and apply v4 configs
if [[ "$SKIP_V4_TEST" == "false" ]]; then
  echo -e "${CYAN}Step 1: Testing v4 configurations${NC}"
  echo -e "${YELLOW}Running terraform init in v4/...${NC}"
  cd "${V4_DIR}"

  # Configure backend for terraform init
  # Check required environment variables for remote state
  if [[ -z "${R2_ACCESS_KEY_ID:-}" ]] || [[ -z "${R2_SECRET_ACCESS_KEY:-}" ]]; then
      echo -e "${RED}Error: R2 credentials not set${NC}"
      echo "Please set: R2_ACCESS_KEY_ID and R2_SECRET_ACCESS_KEY"
      exit 1
  fi

  # Create backend config with account ID
  BACKEND_CONFIG="${V4_DIR}/backend.hcl"
  BACKEND_CONFIG_TMP="${V4_DIR}/backend.configured.hcl"
  sed "s/ACCOUNT_ID/${CLOUDFLARE_ACCOUNT_ID}/g" "$BACKEND_CONFIG" > "$BACKEND_CONFIG_TMP"

  # Set R2 credentials (Terraform uses AWS S3-compatible API)
  export AWS_ACCESS_KEY_ID="$R2_ACCESS_KEY_ID"
  export AWS_SECRET_ACCESS_KEY="$R2_SECRET_ACCESS_KEY"

  # Clean .terraform if switching accounts to avoid migration prompts
  if [[ -f "${V4_DIR}/.terraform/terraform.tfstate" ]]; then
      if ! grep -q "${CLOUDFLARE_ACCOUNT_ID}" "${V4_DIR}/.terraform/terraform.tfstate" 2>/dev/null; then
          echo -e "${YELLOW}Detected account switch, cleaning .terraform directory...${NC}"
          rm -rf "${V4_DIR}/.terraform"
      fi
  fi

  # If local state exists and we're using remote backend, back it up and remove it
  # to avoid migration prompts (remote state is the source of truth)
  if [[ -f "${V4_DIR}/terraform.tfstate" ]]; then
      echo -e "${YELLOW}Found local state file, backing up and using remote state...${NC}"
      cp "${V4_DIR}/terraform.tfstate" "${V4_DIR}/terraform.tfstate.backup"
      rm -f "${V4_DIR}/terraform.tfstate"
      rm -f "${V4_DIR}/terraform.tfstate.backup"  # No need to keep backup for e2e tests
  fi

  if ! terraform init -no-color -reconfigure -backend-config="$BACKEND_CONFIG_TMP" > "${TMP_DIR}/v4-init.log" 2>&1; then
      echo -e "${RED}✗ Terraform init failed for v4${NC}"
      echo ""
      echo -e "${RED}Error output:${NC}"
      cat "${TMP_DIR}/v4-init.log"
      rm -f "$BACKEND_CONFIG_TMP"
      exit 1
  fi
  echo -e "${GREEN}✓ Terraform init successful (remote state loaded from R2)${NC}"

  # Clean up temp backend config
  rm -f "$BACKEND_CONFIG_TMP"

  echo -e "${YELLOW}Running terraform plan in v4/...${NC}"
  if ! terraform plan -no-color -out="${TMP_DIR}/v4.tfplan" -input=false ${TARGET_ARGS} > "${TMP_DIR}/v4-plan.log" 2>&1; then
      echo -e "${RED}✗ Terraform plan failed for v4${NC}"
      echo ""
      echo -e "${RED}Error output:${NC}"
      cat "${TMP_DIR}/v4-plan.log"
      exit 1
  fi

  # Extract plan summary
  V4_PLAN_SUMMARY=$(grep -E "^Plan: " "${TMP_DIR}/v4-plan.log" || echo "")

  # Check if plan shows any changes
  if grep -q "No changes" "${TMP_DIR}/v4-plan.log"; then
      echo -e "${GREEN}✓ Terraform plan shows no changes${NC}"
  else
      echo -e "${GREEN}✓ Terraform plan successful${NC}"
      if [[ -n "$V4_PLAN_SUMMARY" ]]; then
          echo -e "  ${V4_PLAN_SUMMARY}"
      fi
      echo ""

      # Show detailed changes - extract the entire resource change sections
      echo -e "${YELLOW}Detailed changes:${NC}"
      echo ""

      # Use awk to extract resource blocks with their changes
      awk '
      /^Terraform will perform the following actions:/ { in_changes=1; next }
      /^Plan: / { in_changes=0 }
      in_changes && /^  # / {
          # Start of a resource block
          print "\033[1;33m" $0 "\033[0m"
          getline
          while ($0 ~ /^  [^ ]/ || $0 ~ /^      / || $0 ~ /^        /) {
              # Highlight attribute changes
              if ($0 ~ /~ /) {
                  print "\033[0;33m" $0 "\033[0m"
              } else if ($0 ~ /\+ /) {
                  print "\033[0;32m" $0 "\033[0m"
              } else if ($0 ~ /- /) {
                  print "\033[0;31m" $0 "\033[0m"
              } else if ($0 ~ /-\/\+ /) {
                  print "\033[0;35m" $0 "\033[0m"
              } else {
                  print $0
              }
              getline
          }
          print ""
      }
      ' "${TMP_DIR}/v4-plan.log"
  fi
  echo ""

  echo -e "${YELLOW}Running terraform apply in v4/...${NC}"
  if ! terraform apply -no-color -auto-approve -input=false "${TMP_DIR}/v4.tfplan" > "${TMP_DIR}/v4-apply.log" 2>&1; then
      echo -e "${RED}✗ Terraform apply failed for v4${NC}"
      echo ""
      echo -e "${RED}Error output:${NC}"
      cat "${TMP_DIR}/v4-apply.log"
      exit 1
  fi
  echo -e "${GREEN}✓ Terraform apply successful${NC}"

  # Show apply summary
  V4_APPLY_SUMMARY=$(grep -E "^Apply complete!" "${TMP_DIR}/v4-apply.log" || echo "")
  if [[ -n "$V4_APPLY_SUMMARY" ]]; then
      echo -e "  ${V4_APPLY_SUMMARY}"
  fi

  # Pull state from remote to ensure local file is up to date
  echo -e "${YELLOW}Syncing state from remote...${NC}"
  if terraform state pull > terraform.tfstate 2>/dev/null; then
      echo -e "${GREEN}✓ Local state file synced from R2${NC}"
  else
      echo -e "${YELLOW}⚠ Could not pull state (may be empty)${NC}"
  fi

  # Capture v4 state
  echo -e "${YELLOW}Capturing v4 state...${NC}"
  terraform show -no-color -json > "${TMP_DIR}/v4-state.json"
  echo -e "${GREEN}✓ Saved v4 state to tmp/v4-state.json${NC}"

  # Note: State is automatically synced to R2 remote backend after apply
  # The terraform state pull command above ensures the local file is visible
  echo ""
else
  echo -e "${CYAN}Step 1: Skipped v4 testing (--skip-v4-test)${NC}"
  echo ""
fi

# Step 2: Run migration
echo ""
echo -e "${CYAN}Step 2: Running migration${NC}"
cd "${E2E_ROOT}"
echo -e "${YELLOW}Running ./scripts/migrate...${NC}"
if ! ./scripts/migrate > "${TMP_DIR}/migrate.log" 2>&1; then
    echo -e "${RED}✗ Migration failed${NC}"
    echo ""
    echo -e "${RED}Error output:${NC}"
    cat "${TMP_DIR}/migrate.log"
    exit 1
fi
echo -e "${GREEN}✓ Migration successful${NC}"

# Step 3: Initialize and apply v5 configs
echo ""
echo -e "${CYAN}Step 3: Testing v5 configurations${NC}"
echo -e "${YELLOW}Running terraform init in migrated-v4_to_v5/...${NC}"
cd "${V5_DIR}"

# Clean .terraform if it exists (in case of previous runs with different accounts)
if [[ -d "${V5_DIR}/.terraform" ]]; then
    echo -e "${YELLOW}Cleaning v5 .terraform directory for fresh init...${NC}"
    rm -rf "${V5_DIR}/.terraform"
fi

if ! terraform init -no-color -input=false > "${TMP_DIR}/v5-init.log" 2>&1; then
    echo -e "${RED}✗ Terraform init failed for v5${NC}"
    echo ""
    echo -e "${RED}Error output:${NC}"
    cat "${TMP_DIR}/v5-init.log"
    exit 1
fi
echo -e "${GREEN}✓ Terraform init successful${NC}"

echo -e "${YELLOW}Running terraform plan in v5/...${NC}"
if ! terraform plan -no-color -out="${TMP_DIR}/v5.tfplan" -input=false ${TARGET_ARGS} > "${TMP_DIR}/v5-plan.log" 2>&1; then
    echo -e "${RED}✗ Terraform plan failed for v5${NC}"
    echo ""
    echo -e "${RED}Error output:${NC}"
    cat "${TMP_DIR}/v5-plan.log"
    exit 1
fi

# Extract plan summary
PLAN_SUMMARY=$(grep -E "^Plan: " "${TMP_DIR}/v5-plan.log" || echo "")
HAS_CHANGES=false

# Check if plan shows any changes
if grep -q "No changes" "${TMP_DIR}/v5-plan.log"; then
    echo -e "${GREEN}✓ Terraform plan shows no changes (expected)${NC}"
else
    HAS_CHANGES=true
    echo -e "${YELLOW}⚠ Terraform plan shows changes${NC}"
    if [[ -n "$PLAN_SUMMARY" ]]; then
        echo -e "  ${PLAN_SUMMARY}"
    fi
    echo ""

    # Show detailed changes - extract the entire resource change sections
    echo -e "${YELLOW}Detailed changes:${NC}"
    echo ""

    # Use awk to extract resource blocks with their changes
    awk '
    /^Terraform will perform the following actions:/ { in_changes=1; next }
    /^Plan: / { in_changes=0 }
    in_changes && /^  # / {
        # Start of a resource block
        print "\033[1;33m" $0 "\033[0m"
        getline
        while ($0 ~ /^  [^ ]/ || $0 ~ /^      / || $0 ~ /^        /) {
            # Highlight attribute changes
            if ($0 ~ /~ /) {
                print "\033[0;33m" $0 "\033[0m"
            } else if ($0 ~ /\+ /) {
                print "\033[0;32m" $0 "\033[0m"
            } else if ($0 ~ /- /) {
                print "\033[0;31m" $0 "\033[0m"
            } else if ($0 ~ /-\/\+ /) {
                print "\033[0;35m" $0 "\033[0m"
            } else {
                print $0
            }
            getline
        }
        print ""
    }
    ' "${TMP_DIR}/v5-plan.log"

    echo ""
    echo -e "${YELLOW}This may indicate the migration is not idempotent${NC}"
fi

echo -e "${YELLOW}Running terraform apply in v5/...${NC}"
if ! terraform apply -no-color -auto-approve -input=false "${TMP_DIR}/v5.tfplan" > "${TMP_DIR}/v5-apply.log" 2>&1; then
    echo -e "${RED}✗ Terraform apply failed for v5${NC}"
    echo ""
    echo -e "${RED}Error output:${NC}"
    cat "${TMP_DIR}/v5-apply.log"
    exit 1
fi
echo -e "${GREEN}✓ Terraform apply successful${NC}"

# Capture v5 state
echo -e "${YELLOW}Capturing v5 state...${NC}"
terraform show -no-color -json > "${TMP_DIR}/v5-state.json"
echo -e "${GREEN}✓ Saved v5 state to tmp/v5-state.json${NC}"

# Final summary
echo ""
echo -e "${CYAN}========================================${NC}"
echo -e "${GREEN}✓ E2E Test Complete!${NC}"
echo -e "${CYAN}========================================${NC}"
echo ""
echo -e "${YELLOW}Summary:${NC}"
echo -e "  - v4 terraform apply: ${GREEN}SUCCESS${NC}"
echo -e "  - Migration: ${GREEN}SUCCESS${NC}"
if [[ "$HAS_CHANGES" == "true" ]]; then
    echo -e "  - v5 terraform apply: ${YELLOW}WARNING${NC}"
else
    echo -e "  - v5 terraform apply: ${GREEN}SUCCESS${NC}"
fi
if [[ -n "$PLAN_SUMMARY" ]]; then
    echo -e "  - v5 plan: ${PLAN_SUMMARY}"
else
    echo -e "  - v5 plan: No changes"
fi
echo ""
echo -e "${YELLOW}Logs saved to:${NC}"
echo -e "  - ${CYAN}${TMP_DIR}/${NC}"
echo ""

#!/usr/bin/env bash

# init
# Syncs resource files from integration testdata to e2e/v4
# Preserves provider installation, state files, and configuration

set -euo pipefail

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Show usage
show_usage() {
    echo "Usage: $0 [--account <account_id>] [--zone <zone_id>]"
    echo ""
    echo "Optional arguments:"
    echo "  --account    Cloudflare account ID (default: \$CLOUDFLARE_ACCOUNT_ID)"
    echo "  --zone       Cloudflare zone ID (default: \$CLOUDFLARE_ZONE_ID)"
    echo ""
    echo "Example:"
    echo "  $0"
    echo "  $0 --account your-account-id --zone your-zone-id"
    exit 1
}

# Parse command line arguments with defaults from environment
ACCOUNT_ID="${CLOUDFLARE_ACCOUNT_ID}"
ZONE_ID="${CLOUDFLARE_ZONE_ID}"

while [[ $# -gt 0 ]]; do
    case $1 in
        --account)
            ACCOUNT_ID="$2"
            shift 2
            ;;
        --zone)
            ZONE_ID="$2"
            shift 2
            ;;
        -h|--help)
            show_usage
            ;;
        *)
            echo -e "${RED}Error: Unknown argument '$1'${NC}"
            echo ""
            show_usage
            ;;
    esac
done

# Configuration
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
E2E_ROOT="$(dirname "$SCRIPT_DIR")"
V4_DIR="${E2E_ROOT}/tf/v4"
TF_MIGRATE_ROOT="$(dirname "$E2E_ROOT")"
TESTDATA_ROOT="${TF_MIGRATE_ROOT}/integration/v4_to_v5/testdata"

# Check if testdata directory exists
if [[ ! -d "$TESTDATA_ROOT" ]]; then
    echo -e "${RED}Error: Testdata directory not found at $TESTDATA_ROOT${NC}"
    exit 1
fi

echo -e "${BLUE}========================================${NC}"
echo -e "${BLUE}Syncing Test Resources${NC}"
echo -e "${BLUE}========================================${NC}"
echo ""

# Create v4 directory if it doesn't exist
mkdir -p "${V4_DIR}"

# Sync resource files from integration testdata
echo -e "${YELLOW}Syncing resource files from testdata...${NC}"
FILE_COUNT=0

# Find all input directories
INPUT_DIRS=$(find "$TESTDATA_ROOT" -type d -name "input" | sort)

# Store module names for main.tf generation
declare -a MODULE_NAMES

while IFS= read -r input_dir; do
    [[ -z "$input_dir" ]] && continue

    resource_type=$(basename "$(dirname "$input_dir")")
    MODULE_NAMES+=("$resource_type")

    # Create/clean module directory
    module_dir="${V4_DIR}/${resource_type}"
    rm -rf "$module_dir"
    mkdir -p "$module_dir"

    # Sync all .tf files from testdata
    tf_files=$(find "$input_dir" -maxdepth 1 -name "*.tf" -type f)

    if [[ -n "$tf_files" ]]; then
        while IFS= read -r tf_file; do
            [[ -z "$tf_file" ]] && continue
            filename=$(basename "$tf_file")
            dest_file="${module_dir}/${filename}"

            # Copy file
            cp "$tf_file" "$dest_file"
            echo -e "  ${GREEN}✓ ${resource_type}/${filename}${NC}"
            FILE_COUNT=$((FILE_COUNT + 1))
        done <<< "$tf_files"
    fi

    # Create versions.tf dynamically for each module
    versions_file="${module_dir}/versions.tf"
    cat > "$versions_file" << 'VERSIONS_EOF'
terraform {
  required_providers {
    cloudflare = {
      source = "cloudflare/cloudflare"
    }
  }
}
VERSIONS_EOF
    echo -e "  ${GREEN}✓ ${resource_type}/versions.tf${NC}"
    FILE_COUNT=$((FILE_COUNT + 1))
done <<< "$INPUT_DIRS"

echo ""
echo -e "${GREEN}  Total: ${FILE_COUNT} files synced${NC}"
echo ""

# Configure terraform variables
echo -e "${YELLOW}Configuring terraform variables...${NC}"
echo ""

# Write terraform.tfvars for automatic pickup by Terraform
cat > "${V4_DIR}/terraform.tfvars" << EOF
# Auto-generated by init script
# Edit and re-run ./scripts/init to update these values

cloudflare_account_id = "$ACCOUNT_ID"
cloudflare_zone_id    = "$ZONE_ID"
EOF

echo ""
echo -e "${GREEN}  ✓ Saved configuration${NC}"
echo -e "${BLUE}    Account ID: ${ACCOUNT_ID}${NC}"
echo -e "${BLUE}    Zone ID: ${ZONE_ID}${NC}"
echo -e "${GREEN}    File: v4/terraform.tfvars${NC}"
echo ""

# Update main.tf with all discovered modules
echo -e "${YELLOW}Updating main.tf with module references...${NC}"

cat > "${V4_DIR}/main.tf" << 'HEADER'
# Main configuration file that imports all resource modules
# This file ties together all the resource-specific configurations

# Each resource type is in its own subdirectory

HEADER

# Add module blocks for each resource
for module_name in "${MODULE_NAMES[@]}"; do
    cat >> "${V4_DIR}/main.tf" << EOF

module "${module_name}" {
  source = "./${module_name}"

  cloudflare_account_id = var.cloudflare_account_id
  cloudflare_zone_id    = var.cloudflare_zone_id
}
EOF
done

echo -e "${GREEN}  ↻ Updated main.tf with ${#MODULE_NAMES[@]} module references${NC}"

echo ""
echo -e "${BLUE}========================================${NC}"
echo -e "${GREEN}✓ Sync Complete!${NC}"
echo -e "${BLUE}========================================${NC}"
echo ""
echo -e "${YELLOW}Summary:${NC}"
echo -e "  - Terraform v4 configs: ${BLUE}${V4_DIR}${NC}"
echo -e "  - Modules: ${GREEN}${#MODULE_NAMES[@]}${NC}"
echo -e "  - Files synced: ${GREEN}${FILE_COUNT}${NC}"
echo ""

# Configure remote backend
echo -e "${YELLOW}Configuring remote backend...${NC}"

# Check required environment variables
if [[ -z "${CLOUDFLARE_ACCOUNT_ID:-}" ]]; then
    echo -e "${RED}Error: CLOUDFLARE_ACCOUNT_ID environment variable not set${NC}"
    exit 1
fi

if [[ -z "${CLOUDFLARE_ZONE_ID:-}" ]]; then
    echo -e "${RED}Error: CLOUDFLARE_ZONE_ID environment variable not set${NC}"
    exit 1
fi

if [[ -z "${CLOUDFLARE_API_KEY:-}" ]]; then
    echo -e "${RED}Error: CLOUDFLARE_API_KEY environment variable not set${NC}"
    exit 1
fi

if [[ -z "${CLOUDFLARE_EMAIL:-}" ]]; then
    echo -e "${RED}Error: CLOUDFLARE_EMAIL environment variable not set${NC}"
    exit 1
fi

if [[ -z "${R2_ACCESS_KEY_ID:-}" ]] || [[ -z "${R2_SECRET_ACCESS_KEY:-}" ]]; then
    echo -e "${RED}Error: R2 credentials not set${NC}"
    echo "Please set: R2_ACCESS_KEY_ID and R2_SECRET_ACCESS_KEY"
    exit 1
fi

# Create backend config with account ID
BACKEND_CONFIG="${V4_DIR}/backend.hcl"
BACKEND_CONFIG_TMP="${V4_DIR}/backend.configured.hcl"

sed "s/ACCOUNT_ID/${CLOUDFLARE_ACCOUNT_ID}/g" "$BACKEND_CONFIG" > "$BACKEND_CONFIG_TMP"

# Set R2 credentials (Terraform uses AWS S3-compatible API)
export AWS_ACCESS_KEY_ID="$R2_ACCESS_KEY_ID"
export AWS_SECRET_ACCESS_KEY="$R2_SECRET_ACCESS_KEY"

echo -e "${GREEN}  ✓ Backend configured${NC}"
echo ""

# Check if terraform is initialized
if [[ -d "${V4_DIR}/.terraform" ]]; then
    echo -e "${BLUE}  ✓ Provider installation preserved${NC}"
    echo -e "${BLUE}  ✓ Backend already configured${NC}"
    # No need to re-init, backend is already set up and state will be pulled automatically on next terraform operation
else
    echo -e "${YELLOW}  Note: Run 'cd tf/v4 && terraform init -backend-config=backend.configured.hcl' to initialize${NC}"
fi

# Clean up temp backend config
rm -f "$BACKEND_CONFIG_TMP"

echo ""
echo -e "${YELLOW}Next steps:${NC}"
if [[ ! -d "${V4_DIR}/.terraform" ]]; then
    echo -e "  ${GREEN}cd tf/v4 && terraform init -backend-config=backend.configured.hcl && terraform apply${NC}"
else
    echo -e "  ${GREEN}cd tf/v4 && terraform apply${NC}"
fi
echo ""
echo -e "${BLUE}Note: Configuration is automatically loaded from terraform.tfvars${NC}"
echo -e "${BLUE}      State is managed remotely in R2${NC}"
echo ""
